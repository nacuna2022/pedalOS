# pull in the config file so we can inspect some other CONFIG_ we are
# interested in.
include $(TOPDIR)/.config
include $(TOPDIR)/scripts/util.mk

# pull in the board make definitions. this will also pull in the toolchain 
# and correct flags for the target system we are building for.
include $(TOPDIR)/board/$(_CONFIG_BOARD_NAME)/defs.mk

# pull in the mcu sources
# MCU make.defs must supply the MCU_SRCS in this file 
#include $(TOPDIR)/mcu/$(_CONFIG_MCU)/Make.def
SRCS-$(CONFIG_STM32H7_ADC) += src/stm32h7xx_hal_adc.c
SRCS-$(CONFIG_STM32H7_CEC) += src/stm32h7xx_hal_cec.c
SRCS-$(CONFIG_STM32H7_COMP) += src/stm32h7xx_hal_comp.c
SRCS-$(CONFIG_STM32H7_CORDIC) += src/stm32h7xx_hal_cordic.c
SRCS-$(CONFIG_STM32H7_CORTEX) += src/stm32h7xx_hal_cortex.c
SRCS-$(CONFIG_STM32H7_CRC) += src/stm32h7xx_hal_crc.c 
SRCS-$(CONFIG_STM32H7_CRC) += src/stm32h7xx_hal_crc_ex.c 
SRCS-$(CONFIG_STM32H7_CRYP) += src/stm32h7xx_hal_cryp.c 
SRCS-$(CONFIG_STM32H7_CRYP) += src/stm32h7xx_hal_cryp_ex.c 
SRCS-$(CONFIG_STM32H7_DAC) += src/stm32h7xx_hal_dac.c
SRCS-$(CONFIG_STM32H7_DAC) += src/stm32h7xx_hal_dac_ex.c
SRCS-$(CONFIG_STM32H7_DCMI) += src/stm32h7xx_hal_dcmi.c
SRCS-$(CONFIG_STM32H7_DMA2D) += src/stm32h7xx_hal_dma2d.c
SRCS-$(CONFIG_STM32H7_DFSDM) += src/stm32h7xx_hal_dfsdm.c
SRCS-$(CONFIG_STM32H7_DMA) += src/stm32h7xx_hal_dma.c
SRCS-$(CONFIG_STM32H7_DMA) += src/stm32h7xx_hal_dma_ex.c
SRCS-$(CONFIG_STM32H7_DSI) += src/stm32h7xx_hal_dsi.c
SRCS-$(CONFIG_STM32H7_DTS) += src/stm32h7xx_hal_dts.c
SRCS-$(CONFIG_STM32H7_ETH) += src/stm32h7xx_hal_eth.c
SRCS-$(CONFIG_STM32H7_ETH) += src/stm32h7xx_hal_eth_ex.c
SRCS-$(CONFIG_STM32H7_EXTI) += src/stm32h7xx_hal_exti.c
SRCS-$(CONFIG_STM32H7_FDCAN) += src/stm32h7xx_hal_fdcan.c
SRCS-$(CONFIG_STM32H7_FLASH) += src/stm32h7xx_hal_flash.c
SRCS-$(CONFIG_STM32H7_FLASH) += src/stm32h7xx_hal_flash_ex.c
SRCS-$(CONFIG_STM32H7_FMAC) += src/stm32h7xx_hal_fmac.c
SRCS-$(CONFIG_STM32H7_GFXMMU) += src/stm32h7xx_hal_gfxmmu.c
SRCS-$(CONFIG_STM32H7_GPIO) += src/stm32h7xx_hal_gpio.c
SRCS-$(CONFIG_STM32H7_HASH) += src/stm32h7xx_hal_hash.c
SRCS-$(CONFIG_STM32H7_HASH) += src/stm32h7xx_hal_hash_ex.c
SRCS-$(CONFIG_STM32H7_HCD) += src/stm32h7xx_hal_hcd.c
SRCS-$(CONFIG_STM32H7_HRTIM) += src/stm32h7xx_hal_hrtim.c
SRCS-$(CONFIG_STM32H7_HSEM) += src/stm32h7xx_hal_hsem.c
SRCS-$(CONFIG_STM32H7_I2C) += src/stm32h7xx_hal_i2c.c
SRCS-$(CONFIG_STM32H7_I2C) += src/stm32h7xx_hal_i2c_ex.c
SRCS-$(CONFIG_STM32H7_I2S) += src/stm32h7xx_hal_i2s.c
SRCS-$(CONFIG_STM32H7_I2S) += src/stm32h7xx_hal_i2s_ex.c
SRCS-$(CONFIG_STM32H7_IRDA) += src/stm32h7xx_hal_irda.c
SRCS-$(CONFIG_STM32H7_IWDG) += src/stm32h7xx_hal_iwdg.c
SRCS-$(CONFIG_STM32H7_JPEG) += src/stm32h7xx_hal_jpeg.c
SRCS-$(CONFIG_STM32H7_LPTIM) += src/stm32h7xx_hal_lptim.c
SRCS-$(CONFIG_STM32H7_LTDC) += src/stm32h7xx_hal_ltdc.c
SRCS-$(CONFIG_STM32H7_LTDC) += src/stm32h7xx_hal_ltdc_ex.c
SRCS-$(CONFIG_STM32H7_MDIOS) += src/stm32h7xx_hal_mdios.c
SRCS-$(CONFIG_STM32H7_MDMA) += src/stm32h7xx_hal_mdma.c
SRCS-$(CONFIG_STM32H7_MMC) += src/stm32h7xx_hal_mmc.c
SRCS-$(CONFIG_STM32H7_MMC) += src/stm32h7xx_hal_mmc_ex.c
SRCS-$(CONFIG_STM32H7_NAND) += src/stm32h7xx_hal_nand.c
SRCS-$(CONFIG_STM32H7_NOR) += src/stm32h7xx_hal_nor.c
SRCS-$(CONFIG_STM32H7_OPAMP) += src/stm32h7xx_hal_opamp.c
SRCS-$(CONFIG_STM32H7_OPAMP) += src/stm32h7xx_hal_opamp_ex.c
SRCS-$(CONFIG_STM32H7_OSPI) += src/stm32h7xx_hal_ospi.c
SRCS-$(CONFIG_STM32H7_OTFDEC) += src/stm32h7xx_hal_otfdec.c
SRCS-$(CONFIG_STM32H7_PCD) += src/stm32h7xx_hal_pcd.c
SRCS-$(CONFIG_STM32H7_PCD) += src/stm32h7xx_hal_pcd_ex.c
SRCS-$(CONFIG_STM32H7_PSSI) += src/stm32h7xx_hal_pssi.c
SRCS-$(CONFIG_STM32H7_PWR) += src/stm32h7xx_hal_pwr.c
SRCS-$(CONFIG_STM32H7_PWR) += src/stm32h7xx_hal_pwr_ex.c
SRCS-$(CONFIG_STM32H7_QSPI) += src/stm32h7xx_hal_qspi.c
SRCS-$(CONFIG_STM32H7_RAMECC) += src/stm32h7xx_hal_ramecc.c
SRCS-$(CONFIG_STM32H7_RCC) += src/stm32h7xx_hal_rcc.c
SRCS-$(CONFIG_STM32H7_RCC) += src/stm32h7xx_hal_rcc_ex.c
SRCS-$(CONFIG_STM32H7_RNG) += src/stm32h7xx_hal_rng.c
SRCS-$(CONFIG_STM32H7_RNG) += src/stm32h7xx_hal_rng_ex.c
SRCS-$(CONFIG_STM32H7_RTC) += src/stm32h7xx_hal_rtc.c
SRCS-$(CONFIG_STM32H7_RTC) += src/stm32h7xx_hal_rtc_ex.c
SRCS-$(CONFIG_STM32H7_SAI) += src/stm32h7xx_hal_sai.c
SRCS-$(CONFIG_STM32H7_SAI) += src/stm32h7xx_hal_sai_ex.c
SRCS-$(CONFIG_STM32H7_SD) += src/stm32h7xx_hal_sd.c
SRCS-$(CONFIG_STM32H7_SD) += src/stm32h7xx_hal_sd_ex.c
SRCS-$(CONFIG_STM32H7_SDRAM) += src/stm32h7xx_hal_sdram.c
SRCS-$(CONFIG_STM32H7_SMARTCARD) += src/stm32h7xx_hal_smartcard.c
SRCS-$(CONFIG_STM32H7_SMARTCARD) += src/stm32h7xx_hal_smartcard_ex.c
SRCS-$(CONFIG_STM32H7_SMBUS) += src/stm32h7xx_hal_smbus.c
SRCS-$(CONFIG_STM32H7_SMBUS) += src/stm32h7xx_hal_smbus_ex.c
SRCS-$(CONFIG_STM32H7_SPDIFRX) += src/stm32h7xx_hal_spdifrx.c
SRCS-$(CONFIG_STM32H7_SPI) += src/stm32h7xx_hal_spi.c
SRCS-$(CONFIG_STM32H7_SPI) += src/stm32h7xx_hal_spi_ex.c
SRCS-$(CONFIG_STM32H7_SRAM) += src/stm32h7xx_hal_sram.c
SRCS-$(CONFIG_STM32H7_SWPMI) += src/stm32h7xx_hal_swpmi.c
SRCS-$(CONFIG_STM32H7_TIM) += src/stm32h7xx_hal_tim.c
SRCS-$(CONFIG_STM32H7_TIM) += src/stm32h7xx_hal_tim_ex.c
SRCS-$(CONFIG_STM32H7_UART) += src/stm32h7xx_hal_uart.c
SRCS-$(CONFIG_STM32H7_USART) += src/stm32h7xx_hal_usart.c
SRCS-$(CONFIG_STM32H7_USART) += src/stm32h7xx_hal_usart_ex.c
SRCS-$(CONFIG_STM32H7_WWDG) += src/stm32h7xx_hal_wwdg.c

SRCS-$(CONFIG_STM32H7_HAL) += src/stm32h7xx_hal.c

CFLAGS-$(CONFIG_STM32H7_HAL)=-DHAL_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_ADC) += -DHAL_ADC_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_CEC) += -DHAL_CEC_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_COMP) += -DHAL_COMP_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_CORDIC) += -DHAL_CORDIC_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_CORTEX) += -DHAL_CORTEX_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_CRC) += -DHAL_CRC_MODULE_ENABLED 
CFLAGS-$(CONFIG_STM32H7_CRYP) += -DHAL_CRYP_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_DAC) += -DHAL_DAC_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_DCMI) += -DHAL_DCMI_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_DMA2D) += -DHAL_DMA2D_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_DFSDM) += -DHAL_DFSDM_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_DMA) += -DHAL_DMA_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_DSI) += -DHAL_DSI_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_DTS) += -DHAL_DTS_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_ETH) += -DHAL_ETH_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_EXTI) += -DHAL_EXTI_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_FDCAN) += -DHAL_FDCAN_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_FLASH) += -DHAL_FLASH_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_FMAC) += -DHAL_FMAC_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_GFXMMU) += -DHAL_GFXMMU_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_GPIO) += -DHAL_GPIO_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_HASH) += -DHAL_HASH_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_HCD) += -DHAL_HCD_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_HRTIM) += -DHAL_HRTIM_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_HSEM) += -DHAL_HSEM_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_I2C) += -DHAL_I2C_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_I2S) += -DHAL_I2S_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_IRDA) += -DHAL_IRDA_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_IWDG) += -DHAL_IWDG_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_JPEG) += -DHAL_JPEG_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_LPTIM) += -DHAL_LPTIM_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_LTDC) += -DHAL_LTDC_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_MDIOS) += -DHAL_MDIOS_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_MDMA) += -DHAL_MDMA_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_MMC) += -DHAL_MMC_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_NAND) += -DHAL_NAND_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_NOR) += -DHAL_NOR_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_OPAMP) += -DHAL_OPAMP_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_OSPI) += -DHAL_OSPI_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_OTFDEC) += -DHAL_OTFDEC_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_PCD) += -DHAL_PCD_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_PSSI) += -DHAL_PSSI_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_PWR) += -DHAL_PWR_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_QSPI) += -DHAL_QSPI_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_RAMECC) += -DHAL_RAMECC_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_RCC) += -DHAL_RCC_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_RNG) += -DHAL_RNG_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_RTC) += -DHAL_RTC_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_SAI) += -DHAL_SAI_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_SD) += -DHAL_SD_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_SDRAM) += -DHAL_SDRAM_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_SMARTCARD) += -DHAL_SMARTCARD_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_SMBUS) += -DHAL_SMBUS_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_SPDIFRX) += -DHAL_SPDIFRX_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_SPI) += -DHAL_SPI_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_SRAM) += -DHAL_SRAM_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_SWPMI) += -DHAL_SWPMI_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_TIM) += -DHAL_TIM_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_UART) += -DHAL_UART_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_USART) += -DHAL_USART_MODULE_ENABLED
CFLAGS-$(CONFIG_STM32H7_WWDG) += -DHAL_WWDG_MODULE_ENABLED

CFLAGS+=$(CFLAGS-y)

CLEANABLES=$(wildcard src/*.o)

LIBMCU_OBJS=$(SRCS-y:.c=.o)
LIBMCU=$(TOPDIR)/mcu/$(_CONFIG_MCU)/libmcu.a

CFLAGS+=-I$(TOPDIR)/mcu/$(_CONFIG_MCU)/include
CFLAGS+=-I$(TOPDIR)/mcu/$(_CONFIG_MCU)/include/device
CFLAGS+=-I$(TOPDIR)/include/CMSIS
CFLAGS+=$(MCU_CFLAGS)

$(lib): $(LIBMCU_OBJS)
	$(call archive, $(LIBMCU), $^)

%.o: %.c
	$(call compile, $@, $<)

depend: $(SRCS-y:.c=.ddc)

clean:
	$(call remove, $(CLEANABLES))
